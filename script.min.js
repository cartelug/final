document.addEventListener("DOMContentLoaded", () => {
    // --- GLOBAL: MOBILE MENU FOR HOMEPAGE ETC. ---
    const mobileMenuButton = document.getElementById("mobile-menu-button");
    const mainNav = document.getElementById("main-nav");
    if (mobileMenuButton && mainNav) {
        mobileMenuButton.addEventListener("click", () => {
            mainNav.classList.toggle("active");
        });
    }

    // --- ULTIMATE ORDER PAGE LOGIC ---
    // This code only runs if it finds the 'order-page-body' class
    if (document.body.classList.contains('order-page-body')) {
        // --- STATE MANAGEMENT ---
        let userCountry = null;
        let customerName = '';

        // --- ELEMENT SELECTORS ---
        const mainContent = document.getElementById('main-content');
        const countryPopup = document.getElementById('country-popup');
        const featuresPopup = document.getElementById('features-popup');
        const trustPopup = document.getElementById('trust-popup');
        const ugandaBtn = document.getElementById('uganda-btn');
        const southSudanBtn = document.getElementById('south-sudan-btn');
        const featuresNextBtn = document.getElementById('features-next-btn');
        const trustNextBtn = document.getElementById('trust-next-btn');
        const nameInput = document.getElementById('customer-name');
        const trustMessageUg = document.getElementById('trust-message-ug');
        const trustMessageSs = document.getElementById('trust-message-ss');
        const pricingUg = document.getElementById('pricing-uganda');
        const pricingSs = document.getElementById('pricing-south-sudan');
        const progressSteps = document.querySelectorAll('.progress-step');

        // --- FUNCTIONS ---
        const updateProgress = (stepIndex) => progressSteps.forEach((s, i) => s.classList.toggle('active', i <= stepIndex));
        const openPopup = (el) => el && el.classList.add('active');
        const closePopup = (el) => el && el.classList.remove('active');

        function showPricing() {
            if (userCountry === 'uganda') pricingUg.classList.remove('hidden');
            else if (userCountry === 'south-sudan') pricingSs.classList.remove('hidden');
            mainContent.classList.add('visible');
            document.body.classList.remove('order-page-body');
        }

        // --- EVENT LISTENERS ---
        ugandaBtn?.addEventListener('click', () => {
            userCountry = 'uganda';
            closePopup(countryPopup);
            openPopup(featuresPopup);
            updateProgress(1);
        });

        southSudanBtn?.addEventListener('click', () => {
            userCountry = 'south-sudan';
            closePopup(countryPopup);
            openPopup(featuresPopup);
            updateProgress(1);
        });

        featuresNextBtn?.addEventListener('click', () => {
            closePopup(featuresPopup);
            trustMessageUg.classList.toggle('hidden', userCountry !== 'uganda');
            trustMessageSs.classList.toggle('hidden', userCountry !== 'south-sudan');
            openPopup(trustPopup);
            updateProgress(2);
        });

        trustNextBtn?.addEventListener('click', () => {
            customerName = nameInput.value.trim();
            if (!customerName) {
                alert('Please enter your name.');
                nameInput.focus();
                return;
            }
            closePopup(trustPopup);
            showPricing();
            updateProgress(3);
        });
        
        document.querySelectorAll('.price-card .cta-button').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!customerName) {
                    alert('An error occurred. Please refresh the page.');
                    return;
                }
                const card = e.currentTarget.closest('.price-card');
                const duration = card.querySelector('h3').textContent;
                const price = card.querySelector('.new-price').textContent;

                const message = `Order for AccessUG:\n\nService: Netflix\nName: ${customerName}\nCountry: ${userCountry}\nPackage: ${duration}\nPrice: ${price}\n\nPlease connect me.`;
                
                window.open(`https://wa.me/256762193386?text=${encodeURIComponent(message)}`, '_blank');
            });
        });

        // --- INITIALIZATION ---
        openPopup(countryPopup);
        updateProgress(0);
    }
});
