document.addEventListener("DOMContentLoaded", () => {
    // --- STATE MANAGEMENT ---
    let userCountry = null;

    // --- ELEMENT SELECTORS ---
    const mainContent = document.getElementById('main-content');
    
    // Popups
    const countryPopup = document.getElementById('country-popup');
    const featuresPopup = document.getElementById('features-popup');
    const trustPopup = document.getElementById('trust-popup');

    // Buttons
    const ugandaBtn = document.getElementById('uganda-btn');
    const southSudanBtn = document.getElementById('south-sudan-btn');
    const featuresNextBtn = document.getElementById('features-next-btn');
    const trustNextBtn = document.getElementById('trust-next-btn');

    // Content sections
    const trustMessageUg = document.getElementById('trust-message-ug');
    const trustMessageSs = document.getElementById('trust-message-ss');
    const pricingUg = document.getElementById('pricing-uganda');
    const pricingSs = document.getElementById('pricing-south-sudan');
    
    // Progress Indicator
    const progressSteps = document.querySelectorAll('.progress-step');

    // --- FUNCTIONS ---
    function updateProgress(stepIndex) {
        progressSteps.forEach((step, index) => {
            if (index <= stepIndex) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
    }

    function openPopup(popupElement) {
        if (popupElement) popupElement.classList.add('active');
    }

    function closePopup(popupElement) {
        if (popupElement) popupElement.classList.remove('active');
    }

    function showPricing() {
        if (userCountry === 'uganda') {
            pricingUg.classList.remove('hidden');
        } else if (userCountry === 'south-sudan') {
            pricingSs.classList.remove('hidden');
        }
        mainContent.classList.add('visible');
        document.body.classList.remove('order-page-body'); // Allow scrolling
    }
    
    // --- EVENT LISTENERS ---

    // Step 1: Country Selection
    if (ugandaBtn) {
        ugandaBtn.addEventListener('click', () => {
            userCountry = 'uganda';
            closePopup(countryPopup);
            openPopup(featuresPopup);
            updateProgress(1);
        });
    }
    
    if (southSudanBtn) {
        southSudanBtn.addEventListener('click', () => {
            userCountry = 'south-sudan';
            closePopup(countryPopup);
            openPopup(featuresPopup);
            updateProgress(1);
        });
    }

    // Step 2: Features Confirmation
    if (featuresNextBtn) {
        featuresNextBtn.addEventListener('click', () => {
            closePopup(featuresPopup);
            // Show correct trust message
            if (userCountry === 'uganda') {
                trustMessageUg.classList.remove('hidden');
            } else {
                trustMessageSs.classList.remove('hidden');
            }
            openPopup(trustPopup);
            updateProgress(2);
        });
    }
    
    // Step 3: Trust Confirmation
    if (trustNextBtn) {
        trustNextBtn.addEventListener('click', () => {
            closePopup(trustPopup);
            showPricing();
            updateProgress(3);
        });
    }
    
    // Step 4: Final Order on WhatsApp
    document.querySelectorAll('.price-card .cta-button').forEach(button => {
        button.addEventListener('click', (e) => {
            const card = e.currentTarget.closest('.price-card');
            const duration = card.querySelector('h3').textContent;
            const price = card.querySelector('.new-price').textContent;

            const message = `Order for AccessUG:\n\nService: Netflix\nCountry: ${userCountry}\nPackage: ${duration}\nPrice: ${price}\n\nPlease connect me.`;
            
            window.open(`https://wa.me/256762193386?text=${encodeURIComponent(message)}`, '_blank');
        });
    });

    // --- INITIALIZATION ---
    openPopup(countryPopup);
    updateProgress(0);
});
